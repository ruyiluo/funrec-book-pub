<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    
    <title>2.2.3. u2i召回 &#8212; FunRec 推荐系统 0.0.1 documentation</title>

    <link rel="stylesheet" href="../../_static/material-design-lite-1.3.0/material.blue-deep_orange.min.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/sphinx_materialdesign_theme.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/fontawesome/all.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/fonts.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/basic.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/d2l.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/d2l.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="2.2.4. 总结" href="3.summary.html" />
    <link rel="prev" title="2.2.2. i2i召回" href="1.i2i.html" /> 
  </head>
<body>
    <div class="mdl-layout mdl-js-layout mdl-layout--fixed-header mdl-layout--fixed-drawer"><header class="mdl-layout__header mdl-layout__header--waterfall ">
    <div class="mdl-layout__header-row">
        
        <nav class="mdl-navigation breadcrumb">
            <a class="mdl-navigation__link" href="../index.html"><span class="section-number">2. </span>召回模型</a><i class="material-icons">navigate_next</i>
            <a class="mdl-navigation__link" href="index.html"><span class="section-number">2.2. </span>向量召回</a><i class="material-icons">navigate_next</i>
            <a class="mdl-navigation__link is-active"><span class="section-number">2.2.3. </span>u2i召回</a>
        </nav>
        <div class="mdl-layout-spacer"></div>
        <nav class="mdl-navigation">
        
<form class="form-inline pull-sm-right" action="../../search.html" method="get">
      <div class="mdl-textfield mdl-js-textfield mdl-textfield--expandable mdl-textfield--floating-label mdl-textfield--align-right">
        <label id="quick-search-icon" class="mdl-button mdl-js-button mdl-button--icon"  for="waterfall-exp">
          <i class="material-icons">search</i>
        </label>
        <div class="mdl-textfield__expandable-holder">
          <input class="mdl-textfield__input" type="text" name="q"  id="waterfall-exp" placeholder="Search" />
          <input type="hidden" name="check_keywords" value="yes" />
          <input type="hidden" name="area" value="default" />
        </div>
      </div>
      <div class="mdl-tooltip" data-mdl-for="quick-search-icon">
      Quick search
      </div>
</form>
        
<a id="button-show-source"
    class="mdl-button mdl-js-button mdl-button--icon"
    href="../../_sources/chapter_1_retrieval/2.embedding/2.u2i.rst.txt" rel="nofollow">
  <i class="material-icons">code</i>
</a>
<div class="mdl-tooltip" data-mdl-for="button-show-source">
Show Source
</div>
        </nav>
    </div>
    <div class="mdl-layout__header-row header-links">
      <div class="mdl-layout-spacer"></div>
      <nav class="mdl-navigation">
      </nav>
    </div>
</header><header class="mdl-layout__drawer">
    
          <!-- Title -->
      <span class="mdl-layout-title">
          <a class="title" href="../../index.html">
              <span class="title-text">
                  FunRec 推荐系统
              </span>
          </a>
      </span>
    
    
      <div class="globaltoc">
        <span class="mdl-layout-title toc">Table Of Contents</span>
        
        
            
            <nav class="mdl-navigation">
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../chapter_preface/index.html">前言</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../chapter_installation/index.html">安装</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../chapter_notation/index.html">符号</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../chapter_0_introduction/index.html">1. 推荐系统概述</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../chapter_0_introduction/0.intro.html">1.1. 推荐系统是什么？</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chapter_0_introduction/1.outline.html">1.2. 本书概览</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">2. 召回模型</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../1.cf/index.html">2.1. 协同过滤</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../1.cf/0.intro.html">2.1.1. 简介</a></li>
<li class="toctree-l3"><a class="reference internal" href="../1.cf/1.usercf.html">2.1.2. 基于用户的协同过滤</a></li>
<li class="toctree-l3"><a class="reference internal" href="../1.cf/2.itemcf.html">2.1.3. 基于物品的协同过滤</a></li>
<li class="toctree-l3"><a class="reference internal" href="../1.cf/3.swing.html">2.1.4. Swing 算法</a></li>
<li class="toctree-l3"><a class="reference internal" href="../1.cf/4.mf.html">2.1.5. 矩阵分解</a></li>
<li class="toctree-l3"><a class="reference internal" href="../1.cf/5.summary.html">2.1.6. 总结</a></li>
</ul>
</li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">2.2. 向量召回</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="0.intro.html">2.2.1. 简介</a></li>
<li class="toctree-l3"><a class="reference internal" href="1.i2i.html">2.2.2. i2i召回</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">2.2.3. u2i召回</a></li>
<li class="toctree-l3"><a class="reference internal" href="3.summary.html">2.2.4. 总结</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../3.sequence/index.html">2.3. 序列召回</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../3.sequence/0.intro.html">2.3.1. 简介</a></li>
<li class="toctree-l3"><a class="reference internal" href="../3.sequence/1.user_interests.html">2.3.2. 深化用户兴趣表示</a></li>
<li class="toctree-l3"><a class="reference internal" href="../3.sequence/2.generateive_recall.html">2.3.3. 生成式召回方法</a></li>
<li class="toctree-l3"><a class="reference internal" href="../3.sequence/3.summary.html">2.3.4. 总结</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../chapter_2_ranking/index.html">3. 精排模型</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../chapter_2_ranking/0.intro.html">3.1. 简介</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chapter_2_ranking/1.wide_and_deep.html">3.2. 记忆与泛化</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chapter_2_ranking/2.feature_crossing/index.html">3.3. 特征交叉</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../chapter_2_ranking/2.feature_crossing/0.intro.html">3.3.1. 简介</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../chapter_2_ranking/2.feature_crossing/1.second_order.html">3.3.2. 二阶特征交叉</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../chapter_2_ranking/2.feature_crossing/2.higher_order.html">3.3.3. 高阶特征交叉</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../chapter_2_ranking/2.feature_crossing/3.summary.html">3.3.4. 总结</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../chapter_2_ranking/3.sequence.html">3.4. 序列建模</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chapter_2_ranking/4.multi_objective/index.html">3.5. 多目标建模</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../chapter_2_ranking/4.multi_objective/1.intro.html">3.5.1. 简介</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../chapter_2_ranking/4.multi_objective/2.arch.html">3.5.2. 基础结构演进</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../chapter_2_ranking/4.multi_objective/3.dependency_modeling.html">3.5.3. 任务依赖建模</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../chapter_2_ranking/4.multi_objective/4.multi_loss_optim.html">3.5.4. 多目标损失融合</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../chapter_2_ranking/4.multi_objective/5.summary.html">3.5.5. 小结</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../chapter_2_ranking/5.multi_scenario/index.html">3.6. 多场景建模</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../chapter_2_ranking/5.multi_scenario/1.intro.html">3.6.1. 简介</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../chapter_2_ranking/5.multi_scenario/2.multi_tower.html">3.6.2. 多塔结构</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../chapter_2_ranking/5.multi_scenario/3.dynamic_weight.html">3.6.3. 动态权重建模</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../chapter_2_ranking/5.multi_scenario/4.summary.html">3.6.4. 小结</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../chapter_3_rerank/index.html">4. 重排模型</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../chapter_3_rerank/1.intro.html">4.1. 简介</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chapter_3_rerank/2.greedy.html">4.2. 基于贪心的重排</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chapter_3_rerank/3.personalized.html">4.3. 基于个性化的重排</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chapter_3_rerank/4.summary.html">4.4. 本章小结</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../chapter_4_trends/index.html">5. 难点及热点研究</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../chapter_4_trends/0.intro.html">5.1. 简介</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chapter_4_trends/1.debias.html">5.2. 模型去偏</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chapter_4_trends/2.cold_start.html">5.3. 冷启动问题</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chapter_4_trends/2.cold_start.html#id2">5.4. 内容冷启动</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chapter_4_trends/2.cold_start.html#id5">5.5. 用户冷启动</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chapter_4_trends/3.generative.html">5.6. 生成式推荐</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chapter_4_trends/4.summary.html">5.7. 本章小结</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../chapter_5_projects/index.html">6. 安装</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../chapter_appendix/index.html">7. Appendix</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../chapter_appendix/word2vec.html">7.1. Word2vec</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../chapter_references/references.html">参考文献</a></li>
</ul>

            </nav>
        
        </div>
    
</header>
        <main class="mdl-layout__content" tabIndex="0">

	<script type="text/javascript" src="../../_static/sphinx_materialdesign_theme.js "></script>
    <header class="mdl-layout__drawer">
    
          <!-- Title -->
      <span class="mdl-layout-title">
          <a class="title" href="../../index.html">
              <span class="title-text">
                  FunRec 推荐系统
              </span>
          </a>
      </span>
    
    
      <div class="globaltoc">
        <span class="mdl-layout-title toc">Table Of Contents</span>
        
        
            
            <nav class="mdl-navigation">
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../chapter_preface/index.html">前言</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../chapter_installation/index.html">安装</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../chapter_notation/index.html">符号</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../chapter_0_introduction/index.html">1. 推荐系统概述</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../chapter_0_introduction/0.intro.html">1.1. 推荐系统是什么？</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chapter_0_introduction/1.outline.html">1.2. 本书概览</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">2. 召回模型</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../1.cf/index.html">2.1. 协同过滤</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../1.cf/0.intro.html">2.1.1. 简介</a></li>
<li class="toctree-l3"><a class="reference internal" href="../1.cf/1.usercf.html">2.1.2. 基于用户的协同过滤</a></li>
<li class="toctree-l3"><a class="reference internal" href="../1.cf/2.itemcf.html">2.1.3. 基于物品的协同过滤</a></li>
<li class="toctree-l3"><a class="reference internal" href="../1.cf/3.swing.html">2.1.4. Swing 算法</a></li>
<li class="toctree-l3"><a class="reference internal" href="../1.cf/4.mf.html">2.1.5. 矩阵分解</a></li>
<li class="toctree-l3"><a class="reference internal" href="../1.cf/5.summary.html">2.1.6. 总结</a></li>
</ul>
</li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">2.2. 向量召回</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="0.intro.html">2.2.1. 简介</a></li>
<li class="toctree-l3"><a class="reference internal" href="1.i2i.html">2.2.2. i2i召回</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">2.2.3. u2i召回</a></li>
<li class="toctree-l3"><a class="reference internal" href="3.summary.html">2.2.4. 总结</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../3.sequence/index.html">2.3. 序列召回</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../3.sequence/0.intro.html">2.3.1. 简介</a></li>
<li class="toctree-l3"><a class="reference internal" href="../3.sequence/1.user_interests.html">2.3.2. 深化用户兴趣表示</a></li>
<li class="toctree-l3"><a class="reference internal" href="../3.sequence/2.generateive_recall.html">2.3.3. 生成式召回方法</a></li>
<li class="toctree-l3"><a class="reference internal" href="../3.sequence/3.summary.html">2.3.4. 总结</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../chapter_2_ranking/index.html">3. 精排模型</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../chapter_2_ranking/0.intro.html">3.1. 简介</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chapter_2_ranking/1.wide_and_deep.html">3.2. 记忆与泛化</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chapter_2_ranking/2.feature_crossing/index.html">3.3. 特征交叉</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../chapter_2_ranking/2.feature_crossing/0.intro.html">3.3.1. 简介</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../chapter_2_ranking/2.feature_crossing/1.second_order.html">3.3.2. 二阶特征交叉</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../chapter_2_ranking/2.feature_crossing/2.higher_order.html">3.3.3. 高阶特征交叉</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../chapter_2_ranking/2.feature_crossing/3.summary.html">3.3.4. 总结</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../chapter_2_ranking/3.sequence.html">3.4. 序列建模</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chapter_2_ranking/4.multi_objective/index.html">3.5. 多目标建模</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../chapter_2_ranking/4.multi_objective/1.intro.html">3.5.1. 简介</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../chapter_2_ranking/4.multi_objective/2.arch.html">3.5.2. 基础结构演进</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../chapter_2_ranking/4.multi_objective/3.dependency_modeling.html">3.5.3. 任务依赖建模</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../chapter_2_ranking/4.multi_objective/4.multi_loss_optim.html">3.5.4. 多目标损失融合</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../chapter_2_ranking/4.multi_objective/5.summary.html">3.5.5. 小结</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../chapter_2_ranking/5.multi_scenario/index.html">3.6. 多场景建模</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../chapter_2_ranking/5.multi_scenario/1.intro.html">3.6.1. 简介</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../chapter_2_ranking/5.multi_scenario/2.multi_tower.html">3.6.2. 多塔结构</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../chapter_2_ranking/5.multi_scenario/3.dynamic_weight.html">3.6.3. 动态权重建模</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../chapter_2_ranking/5.multi_scenario/4.summary.html">3.6.4. 小结</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../chapter_3_rerank/index.html">4. 重排模型</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../chapter_3_rerank/1.intro.html">4.1. 简介</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chapter_3_rerank/2.greedy.html">4.2. 基于贪心的重排</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chapter_3_rerank/3.personalized.html">4.3. 基于个性化的重排</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chapter_3_rerank/4.summary.html">4.4. 本章小结</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../chapter_4_trends/index.html">5. 难点及热点研究</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../chapter_4_trends/0.intro.html">5.1. 简介</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chapter_4_trends/1.debias.html">5.2. 模型去偏</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chapter_4_trends/2.cold_start.html">5.3. 冷启动问题</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chapter_4_trends/2.cold_start.html#id2">5.4. 内容冷启动</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chapter_4_trends/2.cold_start.html#id5">5.5. 用户冷启动</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chapter_4_trends/3.generative.html">5.6. 生成式推荐</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chapter_4_trends/4.summary.html">5.7. 本章小结</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../chapter_5_projects/index.html">6. 安装</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../chapter_appendix/index.html">7. Appendix</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../chapter_appendix/word2vec.html">7.1. Word2vec</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../chapter_references/references.html">参考文献</a></li>
</ul>

            </nav>
        
        </div>
    
</header>

    <div class="document">
        <div class="page-content" role="main">
        
  <section id="u2i">
<span id="id1"></span><h1><span class="section-number">2.2.3. </span>u2i召回<a class="headerlink" href="#u2i" title="Permalink to this heading">¶</a></h1>
<p>在完成了i2i召回的探讨后，我们转向另一条同样重要的技术路径：u2i（用户到物品）召回。如果说i2i召回解决的是“买了这个商品的人还会买什么”的问题，那么u2i召回直面的则是推荐系统的核心命题——“这个用户会喜欢什么商品”。</p>
<p>u2i召回的核心挑战在于如何在庞大的物品库中，快速找到与用户兴趣高度匹配的候选集。传统的协同过滤方法虽然有效，但在面对数亿用户和数千万商品时，计算复杂度成为不可逾越的障碍。u2i召回的演进历程，本质上是一个将复杂的“匹配”问题逐步简化为高效“搜索”问题的过程。</p>
<p>这一转变的关键突破来自于一个统一的架构思想：<strong>双塔模型（Two-Tower
Model）</strong>。无论是经典的因子分解机FM、深度结构化语义模型DSSM，还是YouTube的深度神经网络YouTubeDNN，它们在表面上看起来差异巨大，但在本质上都遵循着同一个设计哲学——将用户和物品分别编码为向量，然后通过向量间的相似度计算来衡量匹配程度。</p>
<p>双塔模型的核心思想是将推荐问题分解为两个相对独立的子问题。<strong>用户塔（User
Tower）</strong>专注于理解用户——处理用户的历史行为、人口统计学特征、上下文信息等，最终输出一个代表用户兴趣的向量<span class="math notranslate nohighlight">\(u\)</span>。<strong>物品塔（Item
Tower）</strong>则专精于刻画物品——整合物品的ID、类别、属性、内容特征等，输出一个表征物品特性的向量<span class="math notranslate nohighlight">\(v\)</span>。</p>
<p>这种“分而治之”的设计带来了巨大的工程优势。在训练完成后，所有物品的向量都可以<strong>离线预计算</strong>并存储在高效的向量检索系统中（如Faiss、Annoy等）。当用户发起推荐请求时，系统只需实时计算用户向量，然后通过<strong>近似最近邻（ANN）搜索</strong>快速找到最相似的物品向量。这种架构的优雅之处在于，它将原本需要<span class="math notranslate nohighlight">\(O(U \times I)\)</span>的用户-物品匹配复杂度，降低到了<span class="math notranslate nohighlight">\(O(U + I)\)</span>的向量计算复杂度。</p>
<p>用户与物品的匹配度通过两个向量的<strong>点积</strong>或<strong>余弦相似度</strong>来衡量：</p>
<div class="math notranslate nohighlight" id="equation-chapter-1-retrieval-2-embedding-2-u2i-0">
<span class="eqno">(2.2.10)<a class="headerlink" href="#equation-chapter-1-retrieval-2-embedding-2-u2i-0" title="Permalink to this equation">¶</a></span>\[score(u, v) = u \cdot v = \sum_{i=1}^{d} u_i v_i\]</div>
<p>其中<span class="math notranslate nohighlight">\(d\)</span>是向量维度,
<span class="math notranslate nohighlight">\(u_i\)</span>和<span class="math notranslate nohighlight">\(v_i\)</span>是向量<span class="math notranslate nohighlight">\(u\)</span>和<span class="math notranslate nohighlight">\(v\)</span>的第<span class="math notranslate nohighlight">\(i\)</span>个分量。这个简单的数学操作背后，蕴含着“语义相似性”的深刻含义——向量空间中的距离反映了用户兴趣与物品特性的匹配程度。</p>
<p>接下来，我们将沿着双塔模型的演进轨迹，从经典的数学基础到现代的深度学习实现，逐一探讨这些里程碑式的工作。</p>
<section id="fm">
<span id="fm-matching-model"></span><h2><span class="section-number">2.2.3.1. </span>FM（因子分解机）：双塔模型的雏形<a class="headerlink" href="#fm" title="Permalink to this heading">¶</a></h2>
<p>虽然因子分解机（Factorization Machine, FM）
<span id="id2">(<a class="reference internal" href="../../chapter_references/references.html#id12" title="Rendle, S. (2010). Factorization machines. 2010 IEEE International conference on data mining (pp. 995–1000).">Rendle, 2010</a>)</span>
诞生于深度学习兴起之前，但它在思想上可以说是双塔模型的雏形。FM的核心贡献在于，它首次将用户-物品的复杂交互，优雅地分解为两个低维向量的内积操作。</p>
<section id="id3">
<h3><span class="section-number">2.2.3.1.1. </span>从交互矩阵到向量内积<a class="headerlink" href="#id3" title="Permalink to this heading">¶</a></h3>
<p>FM模型的完整数学表达式为：</p>
<div class="math notranslate nohighlight" id="equation-chapter-1-retrieval-2-embedding-2-u2i-1">
<span class="eqno">(2.2.11)<a class="headerlink" href="#equation-chapter-1-retrieval-2-embedding-2-u2i-1" title="Permalink to this equation">¶</a></span>\[\hat{y}(\mathbf{x}):=w_{0}+\sum_{i=1}^{n} w_{i} x_{i}+\sum_{i=1}^{n} \sum_{j=i+1}^{n}\left\langle\mathbf{v}_{i}, \mathbf{v}_{j}\right\rangle x_{i} x_{j}\]</div>
<p>这个公式看起来复杂，但其核心思想简单而深刻：每个特征<span class="math notranslate nohighlight">\(i\)</span>都对应一个<span class="math notranslate nohighlight">\(k\)</span>维的隐向量<span class="math notranslate nohighlight">\(\mathbf{v}_i\)</span>，特征间的交互通过这些隐向量的内积<span class="math notranslate nohighlight">\(\langle\mathbf{v}_{i}, \mathbf{v}_{j}\rangle = \sum_{f=1}^{k} v_{i,f} \cdot v_{j,f}\)</span>来建模。</p>
<p>FM的真正巧妙之处在于一个数学变换技巧。原本<span class="math notranslate nohighlight">\(O(n^2)\)</span>复杂度的二阶交互项，可以通过代数运算重写为：</p>
<div class="math notranslate nohighlight" id="equation-chapter-1-retrieval-2-embedding-2-u2i-2">
<span class="eqno">(2.2.12)<a class="headerlink" href="#equation-chapter-1-retrieval-2-embedding-2-u2i-2" title="Permalink to this equation">¶</a></span>\[\sum_{i=1}^{n} \sum_{j=i+1}^{n}\left\langle\mathbf{v}_{i}, \mathbf{v}_{j}\right\rangle x_{i} x_{j} = \frac{1}{2} \sum_{f=1}^{k}\left(\left(\sum_{i=1}^{n} v_{i, f} x_{i}\right)^{2}-\sum_{i=1}^{n} v_{i, f}^{2} x_{i}^{2}\right)\]</div>
<p>这一变换将计算复杂度从<span class="math notranslate nohighlight">\(O(kn^2)\)</span>降低到<span class="math notranslate nohighlight">\(O(kn)\)</span>，使得FM能够处理大规模稀疏数据。</p>
</section>
<section id="id4">
<span id="id5"></span><h3><span class="section-number">2.2.3.1.2. </span>分解为双塔结构<a class="headerlink" href="#id4" title="Permalink to this heading">¶</a></h3>
<p>我来有机地结合这个叙事逻辑，重新组织FM分解为双塔结构的部分：</p>
</section>
<section id="id6">
<h3><span class="section-number">2.2.3.1.3. </span>分解为双塔结构<a class="headerlink" href="#id6" title="Permalink to this heading">¶</a></h3>
<p>当我们将FM应用于召回任务时，关键洞察是将特征分为用户侧特征集<span class="math notranslate nohighlight">\(U\)</span>和物品侧特征集<span class="math notranslate nohighlight">\(I\)</span>。此时需要考虑一个重要的观察：对于同一用户，即便其与不同物品进行交互，用户特征内部之间的一阶、二阶交互项得分都是相同的。这意味着在比较用户与不同物品之间的匹配分时，只需要比较：（1）物品内部之间的特征交互得分；（2）用户和物品之间的特征交互得分。</p>
<p>基于这一观察，我们可以将FM的二阶交互项按照用户和物品特征进行拆分：</p>
<div class="math notranslate nohighlight" id="equation-chapter-1-retrieval-2-embedding-2-u2i-3">
<span class="eqno">(2.2.13)<a class="headerlink" href="#equation-chapter-1-retrieval-2-embedding-2-u2i-3" title="Permalink to this equation">¶</a></span>\[\begin{split}\begin{aligned}
&amp; \frac{1}{2} \sum_{f=1}^{k}\left(\left(\sum_{i=1}^{n} v_{i, f} x_{i}\right)^{2}-\sum_{i=1}^{n} v_{i, f}^{2} x_{i}^{2}\right) \\
=&amp; \frac{1}{2} \sum_{f=1}^{k}\left(\left(\sum_{u \in U} v_{u, f} x_{u} + \sum_{t \in I} v_{t, f} x_{t}\right)^{2}-\sum_{u \in U} v_{u, f}^{2} x_{u}^{2} - \sum_{t\in I} v_{t, f}^{2} x_{t}^{2}\right) \\
=&amp; \frac{1}{2} \sum_{f=1}^{k}\left(\left(\sum_{u \in U} v_{u, f} x_{u}\right)^{2} + \left(\sum_{t \in I} v_{t, f} x_{t}\right)^{2} + 2{\sum_{u \in U} v_{u, f} x_{u}}{\sum_{t \in I} v_{t, f} x_{t}} - \sum_{u \in U} v_{u, f}^{2} x_{u}^{2} - \sum_{t \in I} v_{t, f}^{2} x_{t}^{2}\right)
\end{aligned}\end{split}\]</div>
<p>为了实现向量化召回，我们可以丢弃用户特征内部的交互项（因为对排序无影响），保留物品内部交互和用户-物品交互：</p>
<div class="math notranslate nohighlight" id="equation-chapter-1-retrieval-2-embedding-2-u2i-4">
<span class="eqno">(2.2.14)<a class="headerlink" href="#equation-chapter-1-retrieval-2-embedding-2-u2i-4" title="Permalink to this equation">¶</a></span>\[\text{score}_{FM} = \sum_{t \in I} w_{t} x_{t} + \frac{1}{2} \sum_{f=1}^{k}\left(\left(\sum_{t \in I} v_{t, f} x_{t}\right)^{2}  - \sum_{t \in I} v_{t, f}^{2} x_{t}^{2}\right)  + \sum_{f=1}^{k}\left( {\sum_{u \in U} v_{u, f} x_{u}}{\sum_{t \in I} v_{t, f} x_{t}} \right)\]</div>
<p>这个表达式的关键洞察在于，最后一项实际上是两个向量的内积：<span class="math notranslate nohighlight">\(\sum_{u \in U} v_{u} x_{u}\)</span>
和
<span class="math notranslate nohighlight">\(\sum_{t \in I} v_{t} x_{t}\)</span>。基于这一观察，我们可以将整个匹配分数重新组织为两个向量的内积形式：</p>
<div class="math notranslate nohighlight" id="equation-chapter-1-retrieval-2-embedding-2-u2i-5">
<span class="eqno">(2.2.15)<a class="headerlink" href="#equation-chapter-1-retrieval-2-embedding-2-u2i-5" title="Permalink to this equation">¶</a></span>\[\text{score}_{FM} = V_{item} \cdot V_{user}^T\]</div>
<p>其中：</p>
<ul class="simple">
<li><p>用户向量：<span class="math notranslate nohighlight">\(V_{user} = [1; \sum_{u \in U} v_{u} x_{u}]\)</span></p></li>
<li><p>物品向量：<span class="math notranslate nohighlight">\(V_{item} = [\sum_{t \in I} w_{t} x_{t} + \frac{1}{2} \sum_{f=1}^{k}((\sum_{t \in I} v_{t, f} x_{t})^{2} - \sum_{t \in I} v_{t, f}^{2} x_{t}^{2}); \sum_{t \in I} v_{t} x_{t}]\)</span></p></li>
</ul>
<p>用户向量由两部分拼接得到：第一项为常数1（对应物品向量中的复杂交互项），第二项是用户特征向量的sum
pooling。物品向量同样由两部分组成：第一项包含物品的一阶和二阶内部交互，第二项是物品特征向量的sum
pooling（对应用户-物品交互）。</p>
<p>这个分解证明了复杂的特征交互可以被“编码”到两个独立的向量中，然后通过简单的内积操作来恢复原始的匹配分数。作为较早期的模型，FM展示了双塔结构在推荐系统中的可行性。</p>
</section>
<section id="id7">
<h3><span class="section-number">2.2.3.1.4. </span>代码实践<a class="headerlink" href="#id7" title="Permalink to this heading">¶</a></h3>
<p>首先，我们导入funrec库中的核心组件：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>

<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;../../&quot;</span><span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tensorflow</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">tf</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">funrec</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">funrec.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">build_metrics_table</span>
</pre></div>
</div>
<p>FM模型通过向量分解将复杂的特征交互转化为双塔结构。让我们通过一个简化的例子来理解这一转换：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># FM召回的核心思想</span>
</pre></div>
</div>
<p>现在我们可以使用funrec库快速构建、训练和评估FM召回模型：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">config</span> <span class="o">=</span> <span class="n">funrec</span><span class="o">.</span><span class="n">load_config</span><span class="p">(</span><span class="s1">&#39;../../funrec/config/config_fm_recall.yaml&#39;</span><span class="p">)</span>

<span class="c1"># Step 2: Load data</span>
<span class="n">train_data</span><span class="p">,</span> <span class="n">test_data</span> <span class="o">=</span> <span class="n">funrec</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

<span class="c1"># Step 3: Prepare features (smart handling)</span>
<span class="n">feature_columns</span><span class="p">,</span> <span class="n">processed_data</span> <span class="o">=</span> <span class="n">funrec</span><span class="o">.</span><span class="n">prepare_features</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">train_data</span><span class="p">,</span> <span class="n">test_data</span><span class="p">)</span>

<span class="c1"># Step 4: Train model</span>
<span class="n">models</span> <span class="o">=</span> <span class="n">funrec</span><span class="o">.</span><span class="n">train_model</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">training</span><span class="p">,</span> <span class="n">feature_columns</span><span class="p">,</span> <span class="n">processed_data</span><span class="p">)</span>

<span class="c1"># Step 5: Evaluate model</span>
<span class="n">metrics</span> <span class="o">=</span> <span class="n">funrec</span><span class="o">.</span><span class="n">evaluate_model</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">processed_data</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">evaluation</span><span class="p">,</span> <span class="n">feature_columns</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">build_metrics_table</span><span class="p">(</span><span class="n">metrics</span><span class="p">))</span>
</pre></div>
</div>
<div class="output highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">116</span><span class="o">/</span><span class="mi">116</span> <span class="p">[</span><span class="o">==============================</span><span class="p">]</span> <span class="o">-</span> <span class="mi">0</span><span class="n">s</span> <span class="mi">214</span><span class="n">us</span><span class="o">/</span><span class="n">step</span>
<span class="o">+---------------+---------------+--------------+-----------+-----------+----------+----------------+----------------+---------------+</span>
<span class="o">|</span>   <span class="n">hit_rate</span><span class="o">@</span><span class="mi">10</span> <span class="o">|</span>   <span class="n">hit_rate</span><span class="o">@</span><span class="mi">20</span> <span class="o">|</span>   <span class="n">hit_rate</span><span class="o">@</span><span class="mi">5</span> <span class="o">|</span>   <span class="n">ndcg</span><span class="o">@</span><span class="mi">10</span> <span class="o">|</span>   <span class="n">ndcg</span><span class="o">@</span><span class="mi">20</span> <span class="o">|</span>   <span class="n">ndcg</span><span class="o">@</span><span class="mi">5</span> <span class="o">|</span>   <span class="n">precision</span><span class="o">@</span><span class="mi">10</span> <span class="o">|</span>   <span class="n">precision</span><span class="o">@</span><span class="mi">20</span> <span class="o">|</span>   <span class="n">precision</span><span class="o">@</span><span class="mi">5</span> <span class="o">|</span>
<span class="o">+===============+===============+==============+===========+===========+==========+================+================+===============+</span>
<span class="o">|</span>        <span class="mf">0.0008</span> <span class="o">|</span>        <span class="mf">0.0018</span> <span class="o">|</span>       <span class="mf">0.0003</span> <span class="o">|</span>    <span class="mf">0.0003</span> <span class="o">|</span>    <span class="mf">0.0006</span> <span class="o">|</span>   <span class="mf">0.0002</span> <span class="o">|</span>         <span class="mf">0.0001</span> <span class="o">|</span>         <span class="mf">0.0001</span> <span class="o">|</span>        <span class="mf">0.0001</span> <span class="o">|</span>
<span class="o">+---------------+---------------+--------------+-----------+-----------+----------+----------------+----------------+---------------+</span>
</pre></div>
</div>
</section>
</section>
<section id="dssm">
<h2><span class="section-number">2.2.3.2. </span>DSSM：深度结构化语义模型的双塔实现<a class="headerlink" href="#dssm" title="Permalink to this heading">¶</a></h2>
<p>虽然FM在数学上优雅地实现了向量分解，但它本质上仍是线性模型，对于复杂的非线性用户-物品关系表达能力有限。深度结构化语义模型（Deep
Structured Semantic Model, DSSM） <span id="id8">(<a class="reference internal" href="../../chapter_references/references.html#id20" title="Huang, P.-S., He, X., Gao, J., Deng, L., Acero, A., &amp; Heck, L. (2013). Learning deep structured semantic models for web search using clickthrough data. Proceedings of the 22nd ACM international conference on Information &amp; Knowledge Management (pp. 2333–2338).">Huang <em>et al.</em>, 2013</a>)</span>
的出现，将双塔模型的表达能力推向了新的高度——通过深度神经网络替代线性变换，实现了更强的特征学习和表示能力。
DSSM最初在自然语言处理领域用于文本语义匹配，后来被成功迁移到推荐系统中。其核心思想是通过深度神经网络将用户和物品映射到共同的语义空间中，通过向量间的相似度计算来衡量匹配程度。</p>
<figure class="align-default" id="id17">
<img alt="../../_images/dssm_architecture.svg" src="../../_images/dssm_architecture.svg" /><figcaption>
<p><span class="caption-number">图2.2.5 </span><span class="caption-text">DSSM双塔架构</span><a class="headerlink" href="#id17" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<section id="id9">
<h3><span class="section-number">2.2.3.2.1. </span>推荐中的双塔架构<a class="headerlink" href="#id9" title="Permalink to this heading">¶</a></h3>
<p>在推荐系统中，DSSM的架构包括两个核心部分：用户塔和物品塔，每个塔都是独立的DNN结构。用户特征（如历史行为、人口统计学信息等）经过用户塔处理后输出用户embedding，物品特征（如ID、类别、属性等）经过物品塔处理后输出物品embedding。两个embedding的维度必须保持一致，以便进行后续的相似度计算。</p>
<p>相比FM的线性组合，DSSM的深度结构能够使用户侧和物品侧的特征各自在塔内进行复杂的非线性变换，但两塔之间的交互仅在最终的内积计算时发生。这种设计带来了显著的工程优势——物品向量可以离线预计算，用户向量可以实时计算，然后通过高效的ANN检索完成召回。</p>
</section>
<section id="id10">
<h3><span class="section-number">2.2.3.2.2. </span>多分类训练范式<a class="headerlink" href="#id10" title="Permalink to this heading">¶</a></h3>
<p>DSSM将召回任务视为一个极端多分类问题，将物料库中的所有物品看作不同的类别。模型的目标是最大化用户对正样本物品的预测概率：</p>
<div class="math notranslate nohighlight" id="equation-chapter-1-retrieval-2-embedding-2-u2i-6">
<span class="eqno">(2.2.16)<a class="headerlink" href="#equation-chapter-1-retrieval-2-embedding-2-u2i-6" title="Permalink to this equation">¶</a></span>\[P(y|x,\theta) = \frac{e^{s(x,y)}}{\sum_{j\in M}e^{s(x,y_j)}}\]</div>
<p>这里<span class="math notranslate nohighlight">\(s(x,y)\)</span>表示用户<span class="math notranslate nohighlight">\(x\)</span>和物品<span class="math notranslate nohighlight">\(y\)</span>的相似度分数，<span class="math notranslate nohighlight">\(P(y|x,\theta)\)</span>表示匹配概率，<span class="math notranslate nohighlight">\(M\)</span>表示整个物料库。由于物料库规模庞大，直接计算这个softmax在计算上不可行，因此实际训练时采用负采样技术，为每个正样本采样一定数量的负样本来近似计算。</p>
</section>
<section id="id11">
<h3><span class="section-number">2.2.3.2.3. </span>关键的工程细节<a class="headerlink" href="#id11" title="Permalink to this heading">¶</a></h3>
<p>DSSM的成功不仅来自架构设计，更源于一些关键的工程技巧：</p>
<p><strong>向量归一化</strong>：对用户塔和物品塔输出的embedding进行L2归一化：</p>
<div class="math notranslate nohighlight" id="equation-chapter-1-retrieval-2-embedding-2-u2i-7">
<span class="eqno">(2.2.17)<a class="headerlink" href="#equation-chapter-1-retrieval-2-embedding-2-u2i-7" title="Permalink to this equation">¶</a></span>\[u \leftarrow \frac{u}{||u||_2}, \quad v \leftarrow \frac{v}{||v||_2}\]</div>
<p>归一化的核心作用是解决向量点积的非度量性问题。原始的向量点积不满足三角不等式，可能导致“距离”计算的不一致性。例如，对于三个点<span class="math notranslate nohighlight">\(A=(10,0)\)</span>、<span class="math notranslate nohighlight">\(B=(0,10)\)</span>、<span class="math notranslate nohighlight">\(C=(11,0)\)</span>，使用点积计算会得到<span class="math notranslate nohighlight">\(\text{dist}(A,B) &lt; \text{dist}(A,C)\)</span>，但这与直观的几何距离不符。</p>
<p>通过归一化，向量点积被转化为欧式距离的度量形式。对于归一化向量<span class="math notranslate nohighlight">\(u\)</span>和<span class="math notranslate nohighlight">\(v\)</span>，它们的欧式距离为：</p>
<div class="math notranslate nohighlight" id="equation-chapter-1-retrieval-2-embedding-2-u2i-8">
<span class="eqno">(2.2.18)<a class="headerlink" href="#equation-chapter-1-retrieval-2-embedding-2-u2i-8" title="Permalink to this equation">¶</a></span>\[||u - v|| = \sqrt{2-2\langle u,v \rangle}\]</div>
<p>这种转换的关键意义在于<strong>训练与检索的一致性</strong>：模型训练时使用的相似度计算（归一化后的点积）与线上ANN检索系统使用的距离度量（欧式距离）本质上是等价的。这确保了离线训练学到的向量关系能够在线上检索中得到正确体现，避免了训练-服务不一致的问题。</p>
<p><strong>温度系数调节</strong>：在归一化后的向量计算内积后，除以温度系数<span class="math notranslate nohighlight">\(\tau\)</span>：</p>
<div class="math notranslate nohighlight" id="equation-chapter-1-retrieval-2-embedding-2-u2i-9">
<span class="eqno">(2.2.19)<a class="headerlink" href="#equation-chapter-1-retrieval-2-embedding-2-u2i-9" title="Permalink to this equation">¶</a></span>\[s(u,v) = \frac{\langle u,v \rangle}{\tau}\]</div>
<p>温度系数的引入可以调节softmax分布的“锐利程度”，较小的<span class="math notranslate nohighlight">\(\tau\)</span>使得模型预测更加“确定”，有助于提升训练效果。</p>
</section>
<section id="id12">
<h3><span class="section-number">2.2.3.2.4. </span>双塔模型的效率与精度权衡<a class="headerlink" href="#id12" title="Permalink to this heading">¶</a></h3>
<p>DSSM在推荐系统中广受欢迎的根本原因在于它在效率和效果之间找到了合适的平衡点。双塔结构使得模型在海量候选数据的召回场景下速度极快，虽然效果可能不是最优的，但通常已经足够满足召回阶段的需求。</p>
<p>然而，这种设计也带来了固有的局限性。由于用户塔和物品塔相互独立，两侧特征间的交互信息无法得到充分利用。相比之下，精排模型中用户和物品的特征可以在网络的第一层就开始进行细粒度交互，而双塔模型只能在最后的内积计算时才发生交互。这意味着许多有价值的交互信息在经过各自的DNN结构时可能已经被其他特征所混淆，这是双塔架构天然存在的精度损失。</p>
<p>正是这种权衡关系，使得DSSM成为了召回阶段的经典选择——它用可控的精度损失换取了显著的效率提升，为后续更复杂的排序模型留出了计算资源和优化空间。</p>
</section>
<section id="id13">
<h3><span class="section-number">2.2.3.2.5. </span>代码实践<a class="headerlink" href="#id13" title="Permalink to this heading">¶</a></h3>
<p>DSSM的核心在于TowerModel架构，它通过深度神经网络将用户和物品映射到共同的语义空间：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 双塔模型核心思想：</span>
</pre></div>
</div>
<p>现在我们可以使用funrec库快速构建、训练和评估DSSM模型：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">config</span> <span class="o">=</span> <span class="n">funrec</span><span class="o">.</span><span class="n">load_config</span><span class="p">(</span><span class="s1">&#39;../../funrec/config/config_dssm.yaml&#39;</span><span class="p">)</span>

<span class="c1"># Step 2: Load data</span>
<span class="n">train_data</span><span class="p">,</span> <span class="n">test_data</span> <span class="o">=</span> <span class="n">funrec</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

<span class="c1"># Step 3: Prepare features (smart handling)</span>
<span class="n">feature_columns</span><span class="p">,</span> <span class="n">processed_data</span> <span class="o">=</span> <span class="n">funrec</span><span class="o">.</span><span class="n">prepare_features</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">train_data</span><span class="p">,</span> <span class="n">test_data</span><span class="p">)</span>

<span class="c1"># Step 4: Train model</span>
<span class="n">models</span> <span class="o">=</span> <span class="n">funrec</span><span class="o">.</span><span class="n">train_model</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">training</span><span class="p">,</span> <span class="n">feature_columns</span><span class="p">,</span> <span class="n">processed_data</span><span class="p">)</span>

<span class="c1"># Step 5: Evaluate model</span>
<span class="n">metrics</span> <span class="o">=</span> <span class="n">funrec</span><span class="o">.</span><span class="n">evaluate_model</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">processed_data</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">evaluation</span><span class="p">,</span> <span class="n">feature_columns</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">build_metrics_table</span><span class="p">(</span><span class="n">metrics</span><span class="p">))</span>
</pre></div>
</div>
<div class="output highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">116</span><span class="o">/</span><span class="mi">116</span> <span class="p">[</span><span class="o">==============================</span><span class="p">]</span> <span class="o">-</span> <span class="mi">0</span><span class="n">s</span> <span class="mi">279</span><span class="n">us</span><span class="o">/</span><span class="n">step</span>
<span class="o">+---------------+---------------+--------------+-----------+-----------+----------+----------------+----------------+---------------+</span>
<span class="o">|</span>   <span class="n">hit_rate</span><span class="o">@</span><span class="mi">10</span> <span class="o">|</span>   <span class="n">hit_rate</span><span class="o">@</span><span class="mi">20</span> <span class="o">|</span>   <span class="n">hit_rate</span><span class="o">@</span><span class="mi">5</span> <span class="o">|</span>   <span class="n">ndcg</span><span class="o">@</span><span class="mi">10</span> <span class="o">|</span>   <span class="n">ndcg</span><span class="o">@</span><span class="mi">20</span> <span class="o">|</span>   <span class="n">ndcg</span><span class="o">@</span><span class="mi">5</span> <span class="o">|</span>   <span class="n">precision</span><span class="o">@</span><span class="mi">10</span> <span class="o">|</span>   <span class="n">precision</span><span class="o">@</span><span class="mi">20</span> <span class="o">|</span>   <span class="n">precision</span><span class="o">@</span><span class="mi">5</span> <span class="o">|</span>
<span class="o">+===============+===============+==============+===========+===========+==========+================+================+===============+</span>
<span class="o">|</span>        <span class="mf">0.0412</span> <span class="o">|</span>         <span class="mf">0.049</span> <span class="o">|</span>       <span class="mf">0.0377</span> <span class="o">|</span>    <span class="mf">0.0349</span> <span class="o">|</span>    <span class="mf">0.0369</span> <span class="o">|</span>   <span class="mf">0.0339</span> <span class="o">|</span>         <span class="mf">0.0041</span> <span class="o">|</span>         <span class="mf">0.0025</span> <span class="o">|</span>        <span class="mf">0.0075</span> <span class="o">|</span>
<span class="o">+---------------+---------------+--------------+-----------+-----------+----------+----------------+----------------+---------------+</span>
</pre></div>
</div>
</section>
</section>
<section id="youtubednn">
<h2><span class="section-number">2.2.3.3. </span>YouTubeDNN：从匹配到预测用户下一行为<a class="headerlink" href="#youtubednn" title="Permalink to this heading">¶</a></h2>
<p>YouTube深度神经网络推荐系统 <span id="id14">(<a class="reference internal" href="../../chapter_references/references.html#id28" title="Covington, P., Adams, J., &amp; Sargin, E. (2016). Deep neural networks for youtube recommendations. Proceedings of the 10th ACM conference on recommender systems (pp. 191–198).">Covington <em>et al.</em>, 2016</a>)</span>
代表了双塔模型演进的一个重要里程碑。YouTubeDNN在架构上延续了双塔设计，但引入了一个关键的思想转变：将召回任务重新定义为“预测用户下一个会观看的视频”。</p>
<figure class="align-default" id="id18">
<img alt="../../_images/youtubednn_candidate.png" src="../../_images/youtubednn_candidate.png" />
<figcaption>
<p><span class="caption-number">图2.2.6 </span><span class="caption-text">YouTubeDNN候选生成模型架构</span><a class="headerlink" href="#id18" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<p>YouTubeDNN采用了“非对称”的双塔架构：用户塔集成了观看历史、搜索历史、人口统计学特征等多模态信息，用户观看的视频ID通过嵌入层映射后进行平均池化聚合，模型还引入了“Example
Age”特征来建模内容新鲜度的影响；物品塔则相对简化，本质上是一个巨大的嵌入矩阵，每个视频对应一个可学习的向量，避免了复杂的物品特征工程。</p>
<p>这种“预测下一个观看视频”的任务设定，本质上类似于NLP中的next
token预测，可以自然地建模为一个极端多分类问题：</p>
<div class="math notranslate nohighlight" id="equation-chapter-1-retrieval-2-embedding-2-u2i-10">
<span class="eqno">(2.2.20)<a class="headerlink" href="#equation-chapter-1-retrieval-2-embedding-2-u2i-10" title="Permalink to this equation">¶</a></span>\[P(w_t=i|U,C) = \frac{e^{v_i \cdot u}}{\sum_{j \in V} e^{v_j \cdot u}}\]</div>
<p>这里<span class="math notranslate nohighlight">\(w_t\)</span>表示用户在时间<span class="math notranslate nohighlight">\(t\)</span>观看的视频，<span class="math notranslate nohighlight">\(U\)</span>是用户特征，<span class="math notranslate nohighlight">\(C\)</span>是上下文信息，<span class="math notranslate nohighlight">\(V\)</span>是整个视频库。由于视频库规模庞大，直接计算全量softmax不可行，因此采用sampled
softmax进行高效训练。</p>
<section id="id15">
<h3><span class="section-number">2.2.3.3.1. </span>关键的工程技巧<a class="headerlink" href="#id15" title="Permalink to this heading">¶</a></h3>
<p>YouTubeDNN的成功不仅来自于模型设计，更来自于一系列精心设计的工程技巧：</p>
<p><strong>非对称的时序分割</strong>：传统协同过滤通常随机保留验证项目，但这种做法存在未来信息泄露问题。视频消费具有明显的不对称模式——剧集通常按顺序观看，用户往往从热门内容开始逐步深入小众领域。因此，YouTubeDNN采用时序分割策略：对于作为预测目标的用户观看记录，只使用该目标之前的历史行为作为输入特征。这种“回滚”机制更符合真实的推荐场景。</p>
<figure class="align-default" id="id19">
<img alt="../../_images/youtubednn_temporal_split.png" src="../../_images/youtubednn_temporal_split.png" />
<figcaption>
<p><span class="caption-number">图2.2.7 </span><span class="caption-text">非对称共同观看模式</span><a class="headerlink" href="#id19" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<p><strong>负采样策略</strong>：为了高效处理数百万类别的softmax，模型采用重要性采样技术，每次只对数千个负样本进行计算，将训练速度提升了100多倍。</p>
<p><strong>用户样本均衡</strong>：为每个用户生成固定数量的训练样本，避免高活跃用户主导模型学习。这个看似简单的技巧，对提升长尾用户的推荐效果至关重要。</p>
<p>YouTubeDNN的成功在于建立了一套可扩展、可工程化的推荐系统范式——训练时使用复杂的多分类目标和丰富的用户特征，服务时通过预计算物品向量和实时计算用户向量，配合高效的ANN检索完成召回。这种设计实现了训练复杂度和服务效率的有效平衡，至今仍被广泛借鉴。</p>
</section>
</section>
<section id="id16">
<h2><span class="section-number">2.2.3.4. </span>代码实践<a class="headerlink" href="#id16" title="Permalink to this heading">¶</a></h2>
<p>YouTubeDNN将召回任务重定义为“预测用户下一个会观看的视频”，引入了历史行为序列的处理：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># YouTubeDNN的核心思想：历史行为序列建模</span>
</pre></div>
</div>
<p>现在我们可以使用funrec库快速构建、训练和评估YouTubeDNN模型：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">config</span> <span class="o">=</span> <span class="n">funrec</span><span class="o">.</span><span class="n">load_config</span><span class="p">(</span><span class="s1">&#39;../../funrec/config/config_youtubednn.yaml&#39;</span><span class="p">)</span>

<span class="c1"># Step 2: Load data</span>
<span class="n">train_data</span><span class="p">,</span> <span class="n">test_data</span> <span class="o">=</span> <span class="n">funrec</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

<span class="c1"># Step 3: Prepare features (smart handling)</span>
<span class="n">feature_columns</span><span class="p">,</span> <span class="n">processed_data</span> <span class="o">=</span> <span class="n">funrec</span><span class="o">.</span><span class="n">prepare_features</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">train_data</span><span class="p">,</span> <span class="n">test_data</span><span class="p">)</span>

<span class="c1"># Step 4: Train model</span>
<span class="n">models</span> <span class="o">=</span> <span class="n">funrec</span><span class="o">.</span><span class="n">train_model</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">training</span><span class="p">,</span> <span class="n">feature_columns</span><span class="p">,</span> <span class="n">processed_data</span><span class="p">)</span>

<span class="c1"># Step 5: Evaluate model</span>
<span class="n">metrics</span> <span class="o">=</span> <span class="n">funrec</span><span class="o">.</span><span class="n">evaluate_model</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">processed_data</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">evaluation</span><span class="p">,</span> <span class="n">feature_columns</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">build_metrics_table</span><span class="p">(</span><span class="n">metrics</span><span class="p">))</span>
</pre></div>
</div>
<div class="output highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">+---------------+----------------+---------------+--------------+---------------+-----------+------------+-----------+----------+-----------+----------------+-----------------+----------------+---------------+----------------+</span>
<span class="o">|</span>   <span class="n">hit_rate</span><span class="o">@</span><span class="mi">10</span> <span class="o">|</span>   <span class="n">hit_rate</span><span class="o">@</span><span class="mi">100</span> <span class="o">|</span>   <span class="n">hit_rate</span><span class="o">@</span><span class="mi">20</span> <span class="o">|</span>   <span class="n">hit_rate</span><span class="o">@</span><span class="mi">5</span> <span class="o">|</span>   <span class="n">hit_rate</span><span class="o">@</span><span class="mi">50</span> <span class="o">|</span>   <span class="n">ndcg</span><span class="o">@</span><span class="mi">10</span> <span class="o">|</span>   <span class="n">ndcg</span><span class="o">@</span><span class="mi">100</span> <span class="o">|</span>   <span class="n">ndcg</span><span class="o">@</span><span class="mi">20</span> <span class="o">|</span>   <span class="n">ndcg</span><span class="o">@</span><span class="mi">5</span> <span class="o">|</span>   <span class="n">ndcg</span><span class="o">@</span><span class="mi">50</span> <span class="o">|</span>   <span class="n">precision</span><span class="o">@</span><span class="mi">10</span> <span class="o">|</span>   <span class="n">precision</span><span class="o">@</span><span class="mi">100</span> <span class="o">|</span>   <span class="n">precision</span><span class="o">@</span><span class="mi">20</span> <span class="o">|</span>   <span class="n">precision</span><span class="o">@</span><span class="mi">5</span> <span class="o">|</span>   <span class="n">precision</span><span class="o">@</span><span class="mi">50</span> <span class="o">|</span>
<span class="o">+===============+================+===============+==============+===============+===========+============+===========+==========+===========+================+=================+================+===============+================+</span>
<span class="o">|</span>        <span class="mf">0.0084</span> <span class="o">|</span>         <span class="mf">0.2806</span> <span class="o">|</span>        <span class="mf">0.0358</span> <span class="o">|</span>       <span class="mf">0.0022</span> <span class="o">|</span>        <span class="mf">0.1593</span> <span class="o">|</span>    <span class="mf">0.0033</span> <span class="o">|</span>     <span class="mf">0.0543</span> <span class="o">|</span>      <span class="mf">0.01</span> <span class="o">|</span>   <span class="mf">0.0013</span> <span class="o">|</span>    <span class="mf">0.0347</span> <span class="o">|</span>         <span class="mf">0.0008</span> <span class="o">|</span>          <span class="mf">0.0028</span> <span class="o">|</span>         <span class="mf">0.0018</span> <span class="o">|</span>        <span class="mf">0.0004</span> <span class="o">|</span>         <span class="mf">0.0032</span> <span class="o">|</span>
<span class="o">+---------------+----------------+---------------+--------------+---------------+-----------+------------+-----------+----------+-----------+----------------+-----------------+----------------+---------------+----------------+</span>
</pre></div>
</div>
</section>
</section>


        </div>
        <div class="side-doc-outline">
            <div class="side-doc-outline--content"> 
<div class="localtoc">
    <p class="caption">
      <span class="caption-text">Table Of Contents</span>
    </p>
    <ul>
<li><a class="reference internal" href="#">2.2.3. u2i召回</a><ul>
<li><a class="reference internal" href="#fm">2.2.3.1. FM（因子分解机）：双塔模型的雏形</a><ul>
<li><a class="reference internal" href="#id3">2.2.3.1.1. 从交互矩阵到向量内积</a></li>
<li><a class="reference internal" href="#id4">2.2.3.1.2. 分解为双塔结构</a></li>
<li><a class="reference internal" href="#id6">2.2.3.1.3. 分解为双塔结构</a></li>
<li><a class="reference internal" href="#id7">2.2.3.1.4. 代码实践</a></li>
</ul>
</li>
<li><a class="reference internal" href="#dssm">2.2.3.2. DSSM：深度结构化语义模型的双塔实现</a><ul>
<li><a class="reference internal" href="#id9">2.2.3.2.1. 推荐中的双塔架构</a></li>
<li><a class="reference internal" href="#id10">2.2.3.2.2. 多分类训练范式</a></li>
<li><a class="reference internal" href="#id11">2.2.3.2.3. 关键的工程细节</a></li>
<li><a class="reference internal" href="#id12">2.2.3.2.4. 双塔模型的效率与精度权衡</a></li>
<li><a class="reference internal" href="#id13">2.2.3.2.5. 代码实践</a></li>
</ul>
</li>
<li><a class="reference internal" href="#youtubednn">2.2.3.3. YouTubeDNN：从匹配到预测用户下一行为</a><ul>
<li><a class="reference internal" href="#id15">2.2.3.3.1. 关键的工程技巧</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id16">2.2.3.4. 代码实践</a></li>
</ul>
</li>
</ul>

</div>
            </div>
        </div>

      <div class="clearer"></div>
    </div><div class="pagenation">
     <a id="button-prev" href="1.i2i.html" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--colored" role="botton" accesskey="P">
         <i class="pagenation-arrow-L fas fa-arrow-left fa-lg"></i>
         <div class="pagenation-text">
            <span class="pagenation-direction">Previous</span>
            <div>2.2.2. i2i召回</div>
         </div>
     </a>
     <a id="button-next" href="3.summary.html" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--colored" role="botton" accesskey="N">
         <i class="pagenation-arrow-R fas fa-arrow-right fa-lg"></i>
        <div class="pagenation-text">
            <span class="pagenation-direction">Next</span>
            <div>2.2.4. 总结</div>
        </div>
     </a>
  </div>
        
        </main>
    </div>
  </body>
</html>